#!/bin/sh
#
########################################################################
# Auto APT Upgrade
#
#  Maintainer: id774 <idnanashi@gmail.com>
#
#  v1.0 4/27,2011
#       Confirm connect to network.
#  v0.9 2/27,2011
#       Switch aptitude to apt-get.
#  v0.8 9/2,2010
#       Correspond to CentOS.
#  v0.7 8/5,2010
#       Show return code.
#  v0.6 7/27,2009
#       Upgrade clamav.
#  v0.5 11/10,2008
#       Only simulate upgrade in debian unstable.
#  v0.4 6/21,2008
#       Auto Kernel Upgrade.
#  v0.3 9/20,2007
#       Add freshclam.
#  v0.2 9/14,2007
#       Add log header.
########################################################################

setup_environment() {
    JOBLOG=/var/log/auto-upgrade.log
    # ADMIN_MAIL_ADDRESS=xxxxxx@gmail.com
}

update_debian_or_ubuntu() {
    apt-get update >> $JOBLOG 2>&1 && apt-get -y upgrade >> $JOBLOG 2>&1 && apt-get autoclean >> $JOBLOG 2>&1 && apt-get -y autoremove >> $JOBLOG 2>&1
    echo "Return code is $?">>$JOBLOG 2>&1
}

update_redhat_or_centos() {
    yum -y --exclude subversion update >> $JOBLOG 2>&1 && yum clean all >> $JOBLOG 2>&1
    echo "Return code is $?">>$JOBLOG 2>&1
}

upgrade_from_network() {
    test -f /etc/debian_version && update_debian_or_ubuntu
    test -f /etc/redhat-release && update_redhat_or_centos
    freshclam >> $JOBLOG 2>&1
}

send_mail_to_admin() {
    nkf -w $JOBLOG | mail -s "[cron-log][`/bin/hostname`] APT Upgrade Log" $ADMIN_MAIL_ADDRESS
}

auto_upgrade() {
    echo -n "*** $0: Job start at `/bin/hostname` on ">>$JOBLOG 2>&1
    date "+%Y/%m/%d %T">>$JOBLOG 2>&1
    ping -c 1 id774.net > /dev/null 2>&1 && upgrade_from_network
    echo -n "*** $0: End of Job at `/bin/hostname` on ">>$JOBLOG 2>&1
    date "+%Y/%m/%d %T">>$JOBLOG 2>&1
    echo>>$JOBLOG 2>&1
}

main() {
    setup_environment
    auto_upgrade
    case "$ADMIN_MAIL_ADDRESS" in
      *@*)
        send_mail_to_admin
        ;;
    esac
}

main
